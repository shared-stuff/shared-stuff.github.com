(function(){var a,g,c,d,f=Object.prototype.hasOwnProperty;a=function(b,a){var h,e;e=[];for(h=b;b<=a?h<=a:h>=a;b<=a?h++:h--)e.push(String.fromCharCode(h));return e};c=function(){var b;b=[];for(d=0;9>=d;d++)b.push(""+d);return b}().concat(a(65,90)).concat(a(97,122));g=function(b){return b[Math.floor(Math.random()*b.length)]};this.utils={log:function(b){return console.log(b)},focus:function(b){return setTimeout(function(){return $("#"+b).focus()},100)},cleanObjectFromAngular:function(b){var a,h,e,d,
c;c=[];e=0;for(d=b.length;e<d;e++)a=b[e],c.push(function(){var e;e=[];for(h in a)f.call(a,h)&&(0<=h.indexOf("$$")?e.push(delete a[h]):e.push(void 0));return e}());return c},randomString:function(b){var a,h;h=[];for(a=0;0<=b?a<=b:a>=b;0<=b?a++:a--)h.push(g(c));return h.join("")},doNothing:function(){},defer:function(b){return setTimeout(function(){return b()},1)},isBlank:function(b){return!b||/^\s*$/.test(b)},focusAndSelect:function(b){return setTimeout(function(){return $("#"+b).focus().select()},
100)},applyIfNeeded:function(b,a){return b.$root.$$phase?a():b.$apply(a)}}}).call(this);var remoteStorageUtils=function(){function a(){return location.href.substring(0,location.href.length-location.hash.length).replace(/\/[^\/]*$/,"")+"/remote-storage-login-popup.html"}function g(b,e){remoteStorage.getStorageInfo(b,function(b,a){b?(alert("Could not load storage info"),console.log(b)):(console.log("Storage info received:"),console.log(a),localStorage.setItem(i,JSON.stringify(a)));e(b,a)})}function c(a,e,d,c){var f=JSON.parse(localStorage.getItem(i)),g=localStorage.getItem(b);remoteStorage.createClient(f,
a,g).put(e,d,function(b){b?(console.log('Could not store "'+e+'" in "'+a+'" category'),console.log(b)):console.log('Stored "'+d+'" for key "'+e+'" in "'+a+'" category');c&&c(b)})}var d,f,b="remoteStorageToken",i="userStorageInfo";window.addEventListener("message",function(a){a.origin==location.protocol+"//"+location.host&&(console.log("Received an OAuth token: "+a.data),localStorage.setItem(b,a.data),d(a.data))},!1);return{connect:g,authorize:function(b,e){d=e;var c=JSON.parse(localStorage.getItem(i)),
f=a();console.log("RedirectUrl: "+f);c=remoteStorage.createOAuthAddress(c,b,f);window.open(c)},connectAndAuthorize:function(b,e,c){d=c;var i=a();f=window.open(i);g(b,function(b,a){if(a){var d=remoteStorage.createOAuthAddress(a,e,i);f.location.replace(d)}else f.close()})},getItem:function(a,e,d){var c=JSON.parse(localStorage.getItem(i));if("public"==a)c=remoteStorage.createClient(c,"public");else var f=localStorage.getItem(b),c=remoteStorage.createClient(c,a,f);c.get(e,function(b,c){b?console.log(b):
void 0==c?console.log("There wasn't anything for \""+e+'" in category "'+a+'"'):console.log('We received this for key "'+e+'" in category "'+a+'": '+c);d(b,c)})},setItem:c,isLoggedOn:function(a){(!localStorage.getItem(i)||!localStorage.getItem(b))&&setTimeout(function(){a(!1)},10);try{c("sharedstuff","loggedOnTest","test",function(b){a(!b)})}catch(e){a(!1)}},deleteToken:function(){localStorage.removeItem(b)}}}();(function(){var a,g;g=function(){function a(c){var f;this.title=(null!=c?c.title:void 0)||"";this.description=(null!=c?c.description:void 0)||"";this.visibility=(null!=c?c.visibility:void 0)||"friends";f=(new Date).getTime();this.id=(null!=c?c.id:void 0)||""+f;this.created=(null!=c?c.created:void 0)||f;this.modified=(null!=c?c.modified:void 0)||this.created}a.prototype.modify=function(){return this.modified=(new Date).getTime()};return a}();a=function(){function a(c){c=c||{};this.id=c.id||""+(new Date).getTime();
this.name=c.name||c.userAddress||"";this.userAddress=c.userAddress||"";this.secret=c.secret||""}a.prototype.sanitize=function(){if(utils.isBlank(this.name))return this.name=this.userAddress};return a}();this.Stuff=g;this.Friend=a}).call(this);(function(){var a,g,c,d,f,b,i,h,e,l,j,m=Object.prototype.hasOwnProperty,k=function(b,a){function e(){this.constructor=b}for(var c in a)m.call(a,c)&&(b[c]=a[c]);e.prototype=a.prototype;b.prototype=new e;b.__super__=a.prototype;return b};e=utils.log;h=utils.isBlank;b=utils.doNothing;l=utils.randomString;f=utils.defer;j=remoteStorageUtils;c=function(){function b(a,e){this.category=a;this.key=e}b.prototype.readAllItems=function(b){var a;a=this;return a.dataCache?f(function(){return b(a.dataCache.items)}):
j.getItem(this.category,this.key,function(e,c){a.dataCache=JSON.parse(c||'{"items":[]}');a.dataCache.items||(a.dataCache.items=[]);return b(a.dataCache.items)})};b.prototype.findItemByID=function(b,a){return _.find(b,function(b){return b.id===a})};b.prototype.list=function(b){return this.readAllItems(b)};b.prototype.getItem=function(b,a){return this.readAllItems(function(e){return a(_.find(e,function(a){return a.id===b}))})};b.prototype.save=function(b,a){utils.cleanObjectFromAngular(b);this.dataCache||
(this.dataCache={});this.dataCache.items=b;return j.setItem(this.category,this.key,JSON.stringify(this.dataCache),a)};b.prototype.saveItem=function(b,a){var e;e=this;return this.readAllItems(function(c){var f;(f=e.findItemByID(c,b.id))?c[_.indexOf(c,f)]=b:c.push(b);return e.save(c,a)})};b.prototype.deleteItem=function(b,a){var e;e=this;return this.readAllItems(function(c){var f;f=e.findItemByID(c,b);return e.save(_.without(c,f),a)})};return b}();g=function(a){function e(b,a,c){this.category=b;this.key=
a;this.settingsDAO=c}k(e,a);e.prototype.save=function(a,c){var f;e.__super__.save.call(this,a,c);this.settingsDAO.getSecret(function(e){return j.setItem("public","sharedstuff-"+e,JSON.stringify(a),b)});f=_.filter(a,function(b){return"public"===b.visibility});return j.setItem("public","sharedstuff-public",JSON.stringify(f),b)};return e}(c);(function(){function b(a){this.key=a}b.prototype.readAllItems=function(){return JSON.parse(localStorage.getItem(this.key)||"[]")};b.prototype.findItemByID=function(b,
a){return _.find(b,function(b){return b.id===a})};b.prototype.list=function(b){return b(this.readAllItems())};b.prototype.getItem=function(b,a){return a(_.find(this.readAllItems(),function(a){return a.id===b}))};b.prototype.save=function(b){utils.cleanObjectFromAngular(b);return localStorage.setItem(this.key,JSON.stringify(b))};b.prototype.saveItem=function(b){var a,e;a=this.readAllItems();e=this.findItemByID(a,b.id);a[_.indexOf(a,e)]=b;return this.save(a)};b.prototype.deleteItem=function(b){var a;
a=this.readAllItems();b=this.findItemByID(a,b);return this.save(_.without(a,b))};return b})();d=function(){function b(){this.settings=null;this.key="settings"}b.prototype.readSettings=function(b){var a;a=this;return a.settings?f(function(){return b(a.settings)}):j.getItem("sharedstuff",a.key,function(e,c){var f;f=JSON.parse(c||"{}");a.settings=f;if(f.secret)return b(f);f.secret=l(20);return j.setItem("sharedstuff",a.key,JSON.stringify(f),function(){return b(f)})})};b.prototype.getSecret=function(b){return this.readSettings(function(a){return b(a.secret)})};
return b}();a=function(){function b(a){this.friendDAO=a;this.friendsStuffList=[]}b.prototype.listStuffByFriend=function(b,a){if(b.userAddress)return remoteStorage.getStorageInfo(b.userAddress,function(c,f){var h;h=remoteStorage.createClient(f,"public");return f?h.get(i(b),function(b,e){return e?a(JSON.parse(e||"[]")):a([])}):e(c)})};b.prototype.validateFriend=function(b,a){return utils.isBlank(b.userAddress)?a(["userAddress"]):remoteStorage.getStorageInfo(b.userAddress,function(c,f){var h;if(f)return h=
remoteStorage.createClient(f,"public"),h.get(i(b),function(b,c){if(c)return a([]);e(b);return a(["secret"])});e(c);return a(["userAddress"])})};b.prototype.list=function(b){var a;a=this;return this.friendDAO.list(function(e){var c,f,h,d,g,i;h=0;0===e.length&&b(a.friendsStuffList,"NO_FRIENDS");i=[];d=0;for(g=e.length;d<g;d++)f=e[d],c=function(c){return function(f){a._updateWithLoadedItems(c,f);h++;return b(a.friendsStuffList,h===e.length?"DONE":"LOADING")}},i.push(a.listStuffByFriend(f,c(f)));return i})};
b.prototype._updateWithLoadedItems=function(b,a){var e,c,f,h,d;d=[];f=0;for(h=a.length;f<h;f++)c=a[f],c.owner=b,(e=_.find(this.friendsStuffList,function(b){return b.id===c.id}))?d.push(this.friendsStuffList[_.indexOf(this.friendsStuffList,e)]=c):d.push(this.friendsStuffList.push(c));return d};return b}();i=function(b){return"sharedstuff-"+(!h(b.secret)?b.secret:"public")};c=new c("sharedstuff","myFriendsList");d=new d;angular.module("myApp.services",[]).value("version","0.1").value("settingsDAO",
d).value("stuffDAO",new g("sharedstuff","myStuffList",d)).value("friendDAO",c).value("friendsStuffDAO",new a(c))}).call(this);(function(){var a,g,c,d;c=utils.log;g=utils.applyIfNeeded;d=function(a){return!_.any(["invitation","login"],function(b){return 1===a.indexOf(b)})};a=function(a,b){var i;a.session={userAddress:localStorage.getItem("userAddress"),isLoggedIn:!1};a.logout=function(){remoteStorageUtils.deleteToken();a.session={userAddress:null,isLoggedIn:!1};return b.path("/login")};a.setLoggenOn=function(){a.session={userAddress:localStorage.getItem("userAddress"),isLoggedIn:!0};return a.$digest()};i=function(){var h;
h=b.path();c(h);if(!a.session.isLoggedIn&&d(b.path()))return sessionStorage.setItem("targetPath",h),g(a,function(){return b.path("/login").replace()})};return remoteStorageUtils.isLoggedOn(function(b){b?a.setLoggenOn():(a.session={userAddress:null,isLoggedIn:!1},i());return a.$on("$beforeRouteChange",i)})};a.$inject=["$scope","$location","settingsDAO"];this.AppController=a}).call(this);(function(){var a,g,c,d,f,b,i,h;i=utils.focus;h=utils.focusAndSelect;c=function(a,c,d,g,k){a.friendList=[];a.isAddFriendFormHidden=!0;a.isInviteFriendFormHidden=!0;a.inviteUrl="Loading...";c.list(function(b){a.friendList=b;a.isAddFriendFormHidden=0<a.friendList.length;k.userAddress&&(a.friend=new Friend({userAddress:k.userAddress,secret:k.secret}),a.isAddFriendFormHidden=!1);return a.$digest()});a.showAddForm=function(){a.isAddFriendFormHidden=!1;a.isInviteFriendFormHidden=!0;return i("name")};a.friend=
new Friend;a.addFriend=function(){a.friend.sanitize();return d.validateFriend(a.friend,function(b){if(0===b.length)return a.friendList.push(new Friend(a.friend)),c.save(a.friendList),a.friend=new Friend,a.isAddFriendFormHidden=!0,a.$digest(),i("showAddFriendFormButton");a.showValidationErrors=!0;return window.alert(b.join(",")+" seems invalid")})};a.inviteFriend=function(){a.isInviteFriendFormHidden=!1;a.isAddFriendFormHidden=!0;return g.getSecret(function(c){var d;d=a.session.userAddress;a.inviteUrl=
f(d,c);a.publicInviteUrl=b(d);a.$digest();return h("inviteUrl")})};a.closeInviteFriend=function(){return a.isInviteFriendFormHidden=!0};return i("showAddFriendFormButton")};f=function(a,c){return b(a)+"/"+c};b=function(a){var b;b=window.location;return b.protocol+"//"+b.host+b.pathname+"#"+("/invitation/"+a)};c.$inject=["$scope","friendDAO","friendsStuffDAO","settingsDAO","$routeParams"];a=function(a,b,c,f,d){var h;a.friend=new Friend;a.editMode=!1;a.stuffList=[];a.showValidationErrors=!0;b.getItem(f.id,
function(b){a.friend=new Friend(b);a.$digest();return c.listStuffByFriend(b,function(b){a.stuffList=b;return a.$digest()})});h=function(){return a.$apply(function(){return d.path("/friends")})};a.save=function(){a.friend.sanitize();return c.validateFriend(a.friend,function(c){return 0===c.length?b.saveItem(a.friend,h):window.alert(c.join(",")+" seems invalid")})};a.showEditMode=function(){return a.editMode=!0};return a["delete"]=function(){if(window.confirm('Do you really want to delete your friend "'+
a.friend.name+'"?'))return b.deleteItem(a.friend.id,h)}};a.$inject=["$scope","friendDAO","friendsStuffDAO","$routeParams","$location"];g=function(a,b,c,f,d){var h;a.stuffList=[];h=new Friend({userAddress:f.userAddress,secret:f.secret});a.friend=h;c.listStuffByFriend(h,function(b){a.stuffList=b;return a.$digest()});return a.addFriend=function(){return d.path("/addFriend/"+h.userAddress+"/"+h.secret)}};g.$inject=["$scope","friendDAO","friendsStuffDAO","$routeParams","$location"];d=function(a,c){return c.getSecret(function(c){var d;
d=a.session.userAddress;a.inviteUrl=f(d,c);a.publicInviteUrl=b(d);a.$digest();return h("inviteUrl")})};d.$inject=["$scope","settingsDAO"];this.FriendsController=c;this.FriendEditController=a;this.FriendViewController=g;this.ShareStuffController=d}).call(this);(function(){var a,g,c,d,f;d=utils.focus;f=function(a){return!utils.isBlank(a.title)};c={friends:"Friends","public":"Public"};a=function(a,g){a.stuffList=[];a.isAddStuffFormHidden=!0;a.circles=c;g.list(function(c){a.stuffList=c;a.isAddStuffFormHidden=0<a.stuffList.length;return a.$digest()});a.showAddForm=function(){a.isAddStuffFormHidden=!1;return d("title")};a.stuff=new Stuff;a.addStuff=function(){return f(a.stuff)?(a.stuffList.push(new Stuff(a.stuff)),g.save(a.stuffList,function(){}),a.stuff=new Stuff,
a.isAddStuffFormHidden=!0,d("showAddStuffFormButton")):a.showValidationErrors=!0};return d("showAddStuffFormButton")};a.$inject=["$scope","stuffDAO"];g=function(a,d,h,e){var g;a.stuff=new Stuff;a.circles=c;d.getItem(h.id,function(c){a.stuff=new Stuff(c);return a.$digest()});g=function(){return a.$apply(function(){return e.path("/mystuff")})};a.save=function(){return f(a.stuff)?(a.stuff.modify(),d.saveItem(a.stuff,g)):a.showValidationErrors=!0};return a["delete"]=function(){if(window.confirm('Do you really want to delete this stuff called "'+
a.stuff.title+'"?'))return d.deleteItem(a.stuff.id,g)}};g.$inject=["$scope","stuffDAO","$routeParams","$location"];this.MyStuffController=a;this.MyStuffEditController=g}).call(this);(function(){var a,g;g=utils.log;a=function(a,d,f,b){a.stuffList=[];a.sortAttribute="-modified";a.sortAttributeNames={"-modified":"Newest",title:"Title","owner.name":"Friend"};a.status="LOADING";d(function(){return b.list(function(b,f){a.stuffList=b;a.status=f;return a.$digest()})});return a.sortBy=function(b){g(b);return a.sortAttribute=b}};a.$inject=["$scope","$defer","friendDAO","friendsStuffDAO"];this.FriendsStuffController=a}).call(this);var log=utils.log;function AboutController(a){log("About");log(a.session);a.bla="blase";log(utils.randomString(10))}AboutController.$inject=["$scope"];angular.module("myApp.directives",[]).directive("appVersion",["version",function(a){return function(g,c){c.text(a)}}]).directive("appSelectOnFocus",[function(){return function(a,g){g.bind("focus",function(){g.select()})}}]);angular.module("myApp.filters",[]).filter("interpolate",["version",function(a){return function(g){return(""+g).replace(/\%VERSION\%/mg,a)}}]);(function(){var a,g,c,d;d=utils.focus;a=function(a,b){a.secret="Loading secret ...";return b.getSecret(function(b){a.secret=b;return a.$digest()})};a.$inject=["$scope","settingsDAO"];g=function(a,b,c){return a["export"]=function(){return c.list(function(c){return b.list(function(b){utils.cleanObjectFromAngular(c);utils.cleanObjectFromAngular(b);a.exportedData=JSON.stringify({stuff:c,friends:b});a.$digest();return d("exportTextarea")})})}};g.$inject=["$scope","friendDAO","stuffDAO"];c=function(a,b,
c){a.importDataText="";return a.startImport=function(){var d,e,g;d=JSON.parse(a.importDataText);g=0;e=function(){g--;if(0===g)return window.alert("Import Done!"),a.importDataText=""};null!=d&&d.stuff&&(g++,c.save(d.stuff,e));if(null!=d&&d.friends)return g++,b.save(d.friends,e)}};c.$inject=["$scope","friendDAO","stuffDAO"];this.AccountController=a;this.ExportController=g;this.ImportController=c}).call(this);(function(){var a,g,c;g=utils.log;c=remoteStorageUtils;a=function(a,f){g("Login");return a.login=function(){var b;try{return b=a.userAddress,g("userAddress:"+b),b?c.connectAndAuthorize(b,["public","sharedstuff"],function(){var c;localStorage.setItem("userAddress",b);a.setLoggenOn();c=sessionStorage.getItem("targetPath")||"/";sessionStorage.removeItem("targetPath");return a.$apply(function(){return f.path(c).replace()})}):alert("Please enter a remote storage id!")}catch(i){return g(i)}}};a.$inject=
["$scope","$location","settingsDAO"];this.LoginController=a}).call(this);angular.module("myApp",["myApp.filters","myApp.services","myApp.directives"]).config(["$routeProvider",function(a){a.when("/login",{template:"partials/login.html",controller:LoginController});a.when("/mystuff",{template:"partials/my-stuff.html",controller:MyStuffController});a.when("/mystuff/:id",{template:"partials/my-stuff-edit.html",controller:MyStuffEditController});a.when("/share-stuff",{template:"partials/share-stuff.html",controller:ShareStuffController});a.when("/friends",{template:"partials/friends.html",
controller:FriendsController});a.when("/friends/:id",{template:"partials/friend-edit.html",controller:FriendEditController});a.when("/addFriend/:userAddress/:secret",{template:"partials/friends.html",controller:FriendsController});a.when("/addFriend/:userAddress",{template:"partials/friends.html",controller:FriendsController});a.when("/invitation/:userAddress/:secret",{template:"partials/friend.html",controller:FriendViewController});a.when("/invitation/:userAddress",{template:"partials/friend.html",
controller:FriendViewController});a.when("/friends-stuff",{template:"partials/friends-stuff.html",controller:FriendsStuffController});a.when("/account",{template:"partials/account.html",controller:AccountController});a.when("/export",{template:"partials/account-export.html",controller:ExportController});a.when("/import",{template:"partials/account-import.html",controller:ImportController});a.when("/settings",{template:"partials/account-settings.html",controller:AccountController});a.when("/about",
{template:"partials/about.html",controller:AboutController});a.otherwise({redirectTo:"/friends-stuff"})}]);angular.element(document).ready(function(){angular.bootstrap(document,["myApp"])});
