(function(){var a,e,c,g,f,h,d,i=Object.prototype.hasOwnProperty;a=function(b,k){var d,a;a=[];for(d=b;b<=k?d<=k:d>=k;b<=k?d++:d--)a.push(String.fromCharCode(d));return a};h=function(){var b;b=[];for(d=0;9>=d;d++)b.push(""+d);return b}().concat(a(65,90)).concat(a(97,122));f=function(b){return b[Math.floor(Math.random()*b.length)]};c=function(b){return!b||/^\s*$/.test(b)};e=function(b){var d,a,i;a="";for(d in b)i=b[d],"string"===typeof i?a+=" "+i.toLowerCase():"object"===typeof i&&(a+=" "+e(i));return a};
g=function(b,d){var a;a=e(b);return _.all(d,function(b){return 0<=a.indexOf(b)})};this.utils={log:function(b){return console.log(b)},focus:function(b){return setTimeout(function(){return $("#"+b).focus()},100)},cleanObjectFromAngular:function(b){var d,a,g,c,l;l=[];g=0;for(c=b.length;g<c;g++)d=b[g],l.push(function(){var b;b=[];for(a in d)i.call(d,a)&&(0<=a.indexOf("$$")?b.push(delete d[a]):b.push(void 0));return b}());return l},randomString:function(b){var d,a;a=[];for(d=0;0<=b?d<=b:d>=b;0<=b?d++:
d--)a.push(f(h));return a.join("")},doNothing:function(){},defer:function(b){return setTimeout(function(){return b()},1)},isBlank:c,focusAndSelect:function(b){return setTimeout(function(){return $("#"+b).focus().select()},100)},applyIfNeeded:function(b,d){return b.$root.$$phase?d():b.$apply(d)},search:function(b,d){var a;if(c(d))return b;a=d.toLowerCase().split(/\s+/g);return _.filter(b,function(b){return g(b,a)})}}}).call(this);var remoteStorageUtils=function(){function a(){return location.href.substring(0,location.href.length-location.hash.length).replace(/\/[^\/]*$/,"")+"/remote-storage-login-popup.html"}function e(a,b){remoteStorage.getStorageInfo(a,function(a,i){a?(alert("Could not load storage info"),console.log(a)):(console.log("Storage info received:"),console.log(i),localStorage.setItem(d,JSON.stringify(i)));b(a,i)})}function c(a,b,g,c){var f=JSON.parse(localStorage.getItem(d)),e=localStorage.getItem(h);remoteStorage.createClient(f,
a,e).put(b,g,function(d){d?(console.log('Could not store "'+b+'" in "'+a+'" category'),console.log(d)):console.log('Stored "'+g+'" for key "'+b+'" in "'+a+'" category');c&&c(d)})}var g,f,h="remoteStorageToken",d="userStorageInfo";window.addEventListener("message",function(d){d.origin==location.protocol+"//"+location.host&&(console.log("Received an OAuth token: "+d.data),localStorage.setItem(h,d.data),g(d.data))},!1);return{connect:e,authorize:function(c,b){g=b;var f=JSON.parse(localStorage.getItem(d)),
e=a();console.log("RedirectUrl: "+e);f=remoteStorage.createOAuthAddress(f,c,e);window.open(f)},connectAndAuthorize:function(d,b,c){g=c;var h=a();f=window.open(h);e(d,function(d,a){if(a){var g=remoteStorage.createOAuthAddress(a,b,h);f.location.replace(g)}else f.close()})},getItem:function(a,b,g){var c=JSON.parse(localStorage.getItem(d));if("public"==a)c=remoteStorage.createClient(c,"public");else var f=localStorage.getItem(h),c=remoteStorage.createClient(c,a,f);c.get(b,function(d,c){d?console.log(d):
void 0==c?console.log("There wasn't anything for \""+b+'" in category "'+a+'"'):console.log('We received this for key "'+b+'" in category "'+a+'": '+c);g(d,c)})},setItem:c,isLoggedOn:function(a){(!localStorage.getItem(d)||!localStorage.getItem(h))&&setTimeout(function(){a(!1)},10);try{c("sharedstuff","loggedOnTest","test",function(b){a(!b)})}catch(b){a(!1)}},deleteToken:function(){localStorage.removeItem(h)}}}();(function(){var a,e;e=function(){function a(c){var f;this.title=(null!=c?c.title:void 0)||"";this.description=(null!=c?c.description:void 0)||"";this.visibility=(null!=c?c.visibility:void 0)||"friends";this.link=(null!=c?c.link:void 0)||"";this.image=(null!=c?c.image:void 0)||"";f=(new Date).getTime();this.id=(null!=c?c.id:void 0)||""+f;this.created=(null!=c?c.created:void 0)||f;this.modified=(null!=c?c.modified:void 0)||this.created}a.prototype.modify=function(){return this.modified=(new Date).getTime()};
return a}();a=function(){function a(c){c=c||{};this.id=c.id||""+(new Date).getTime();this.name=c.name||c.userAddress||"";this.userAddress=c.userAddress||"";this.secret=c.secret||""}a.prototype.sanitize=function(){if(utils.isBlank(this.name))return this.name=this.userAddress};return a}();this.Stuff=e;this.Friend=a}).call(this);(function(){var a,e,c,g,f,h,d,i,b,k,j,m=Object.prototype.hasOwnProperty,n=function(b,a){function d(){this.constructor=b}for(var c in a)m.call(a,c)&&(b[c]=a[c]);d.prototype=a.prototype;b.prototype=new d;b.__super__=a.prototype;return b};b=utils.log;i=utils.isBlank;h=utils.doNothing;k=utils.randomString;f=utils.defer;j=remoteStorageUtils;c=function(){function b(a,d){this.category=a;this.key=d}b.prototype.readAllItems=function(b){var a;a=this;return a.dataCache?f(function(){return b(a.dataCache.items)}):
j.getItem(this.category,this.key,function(d,c){a.dataCache=JSON.parse(c||'{"items":[]}');a.dataCache.items||(a.dataCache={items:[]});return b(a.dataCache.items)})};b.prototype.findItemByID=function(b,a){return _.find(b,function(b){return b.id===a})};b.prototype.list=function(b){return this.readAllItems(b)};b.prototype.getItem=function(b,a){return this.readAllItems(function(d){return a(_.find(d,function(a){return a.id===b}))})};b.prototype.save=function(b,a){utils.cleanObjectFromAngular(b);this.dataCache||
(this.dataCache={});this.dataCache.items=b;return j.setItem(this.category,this.key,JSON.stringify(this.dataCache),a)};b.prototype.saveItem=function(b,a){var d;d=this;return this.readAllItems(function(c){var f;(f=d.findItemByID(c,b.id))?c[_.indexOf(c,f)]=b:c.push(b);return d.save(c,a)})};b.prototype.deleteItem=function(b,a){var d;d=this;return this.readAllItems(function(c){var f;f=d.findItemByID(c,b);return d.save(_.without(c,f),a)})};return b}();e=function(b){function a(b,d,c){this.category=b;this.key=
d;this.settingsDAO=c}n(a,b);a.prototype.save=function(b,d){var c;a.__super__.save.call(this,b,d);this.settingsDAO.getSecret(function(a){return j.setItem("public","sharedstuff-"+a,JSON.stringify(b),h)});c=_.filter(b,function(b){return"public"===b.visibility});return j.setItem("public","sharedstuff-public",JSON.stringify(c),h)};return a}(c);(function(){function b(a){this.key=a}b.prototype.readAllItems=function(){return JSON.parse(localStorage.getItem(this.key)||"[]")};b.prototype.findItemByID=function(b,
a){return _.find(b,function(b){return b.id===a})};b.prototype.list=function(b){return b(this.readAllItems())};b.prototype.getItem=function(b,a){return a(_.find(this.readAllItems(),function(a){return a.id===b}))};b.prototype.save=function(b){utils.cleanObjectFromAngular(b);return localStorage.setItem(this.key,JSON.stringify(b))};b.prototype.saveItem=function(b){var a,d;a=this.readAllItems();d=this.findItemByID(a,b.id);a[_.indexOf(a,d)]=b;return this.save(a)};b.prototype.deleteItem=function(b){var a;
a=this.readAllItems();b=this.findItemByID(a,b);return this.save(_.without(a,b))};return b})();g=function(){function b(){this.settings=null;this.key="settings"}b.prototype.readSettings=function(b){var a;a=this;return a.settings?f(function(){return b(a.settings)}):j.getItem("sharedstuff",a.key,function(d,c){var f;f=JSON.parse(c||"{}");a.settings=f;if(f.secret)return b(f);f.secret=k(20);return j.setItem("sharedstuff",a.key,JSON.stringify(f),function(){return b(f)})})};b.prototype.getSecret=function(b){return this.readSettings(function(a){return b(a.secret)})};
return b}();a=function(){function a(b){this.friendDAO=b;this.friendsStuffList=[]}a.prototype.listStuffByFriend=function(a,c){if(a.userAddress)return remoteStorage.getStorageInfo(a.userAddress,function(f,e){var i;i=remoteStorage.createClient(e,"public");return e?i.get(d(a),function(b,a){return a?c(JSON.parse(a||"[]")):c([])}):b(f)})};a.prototype.validateFriend=function(a,c){return utils.isBlank(a.userAddress)?c(["userAddress"]):remoteStorage.getStorageInfo(a.userAddress,function(f,e){var i;if(e)return i=
remoteStorage.createClient(e,"public"),i.get(d(a),function(a,d){if(d)return c([]);b(a);return c(["secret"])});b(f);return c(["userAddress"])})};a.prototype.clearCache=function(){return this.friendsStuffList=[]};a.prototype.list=function(b){var a;a=this;return this.friendDAO.list(function(d){var c,f,e,i,g,h;e=0;0===d.length&&b(a.friendsStuffList,"NO_FRIENDS");h=[];i=0;for(g=d.length;i<g;i++)f=d[i],c=function(c){return function(f){a._updateWithLoadedItems(c,f);e++;return b(a.friendsStuffList,e===d.length?
"LOADED":"LOADING")}},h.push(a.listStuffByFriend(f,c(f)));return h})};a.prototype._updateWithLoadedItems=function(b,a){var d,c,f,e,i;i=[];f=0;for(e=a.length;f<e;f++)c=a[f],c.owner=b,(d=_.find(this.friendsStuffList,function(b){return b.id===c.id}))?i.push(this.friendsStuffList[_.indexOf(this.friendsStuffList,d)]=c):i.push(this.friendsStuffList.push(c));return i};return a}();d=function(b){return"sharedstuff-"+(!i(b.secret)?b.secret:"public")};c=new c("sharedstuff","myFriendsList");g=new g;angular.module("myApp.services",
[]).value("version","0.1").value("settingsDAO",g).value("stuffDAO",new e("sharedstuff","myStuffList",g)).value("friendDAO",c).value("friendsStuffDAO",new a(c))}).call(this);(function(){var a,e,c,g;c=utils.log;e=utils.applyIfNeeded;g=function(a){return!_.any(["invitation","login"],function(c){return 1===a.indexOf(c)})};a=function(a,h){var d;a.session={userAddress:localStorage.getItem("userAddress"),isLoggedIn:!1};a.logout=function(){remoteStorageUtils.deleteToken();a.session={userAddress:null,isLoggedIn:!1};return h.path("/login")};a.setLoggenOn=function(){a.session={userAddress:localStorage.getItem("userAddress"),isLoggedIn:!0};return a.$digest()};d=function(){var d;
d=h.path();c(d);if(!a.session.isLoggedIn&&g(h.path()))return sessionStorage.setItem("targetPath",d),e(a,function(){return h.path("/login").replace()})};return remoteStorageUtils.isLoggedOn(function(c){c?a.setLoggenOn():(a.session={userAddress:null,isLoggedIn:!1},d());return a.$on("$beforeRouteChange",d)})};a.$inject=["$scope","$location","settingsDAO"];this.AppController=a}).call(this);(function(){var a,e,c,g,f,h,d,i;d=utils.focus;i=utils.focusAndSelect;c=function(b,a,c,e,g){b.friendList=[];b.isAddFriendFormHidden=!0;b.isInviteFriendFormHidden=!0;b.inviteUrl="Loading...";a.list(function(a){b.friendList=a;b.isAddFriendFormHidden=0<b.friendList.length;g.userAddress&&(b.friend=new Friend({userAddress:g.userAddress,secret:g.secret}),b.isAddFriendFormHidden=!1);b.status="LOADED";return b.$digest()});b.showAddForm=function(){b.isAddFriendFormHidden=!1;b.isInviteFriendFormHidden=!0;return d("name")};
b.friend=new Friend;b.addFriend=function(){b.friend.sanitize();return c.validateFriend(b.friend,function(c){if(0===c.length)return b.friendList.push(new Friend(b.friend)),a.save(b.friendList),b.friend=new Friend,b.isAddFriendFormHidden=!0,b.$digest(),d("showAddFriendFormButton");b.showValidationErrors=!0;return window.alert(c.join(",")+" seems invalid")})};b.inviteFriend=function(){b.isInviteFriendFormHidden=!1;b.isAddFriendFormHidden=!0;return e.getSecret(function(a){var d;d=b.session.userAddress;
b.inviteUrl=f(d,a);b.publicInviteUrl=h(d);b.$digest();return i("inviteUrl")})};b.closeInviteFriend=function(){return b.isInviteFriendFormHidden=!0};return d("showAddFriendFormButton")};f=function(b,a){return h(b)+"/"+a};h=function(b){var a;a=window.location;return a.protocol+"//"+a.host+a.pathname+"#"+("/invitation/"+b)};c.$inject=["$scope","friendDAO","friendsStuffDAO","settingsDAO","$routeParams"];a=function(b,a,d,c,f){var e;b.friend=new Friend;b.editMode=!1;b.stuffList=[];b.showValidationErrors=
!0;a.getItem(c.id,function(a){b.friend=new Friend(a);b.$digest();return d.listStuffByFriend(a,function(a){b.stuffList=a;return b.$digest()})});e=function(){return b.$apply(function(){return f.path("/friends")})};b.save=function(){b.friend.sanitize();return d.validateFriend(b.friend,function(d){return 0===d.length?a.saveItem(b.friend,e):window.alert(d.join(",")+" seems invalid")})};b.showEditMode=function(){return b.editMode=!0};return b["delete"]=function(){if(window.confirm('Do you really want to delete your friend "'+
b.friend.name+'"?'))return a.deleteItem(b.friend.id,e)}};a.$inject=["$scope","friendDAO","friendsStuffDAO","$routeParams","$location"];e=function(b,a,d,c,f){var e;b.stuffList=[];e=new Friend({userAddress:c.userAddress,secret:c.secret});b.friend=e;d.listStuffByFriend(e,function(a){b.stuffList=a;return b.$digest()});return b.addFriend=function(){return f.path("/addFriend/"+e.userAddress+"/"+e.secret)}};e.$inject=["$scope","friendDAO","friendsStuffDAO","$routeParams","$location"];g=function(b,a){return a.getSecret(function(a){var d;
d=b.session.userAddress;b.inviteUrl=f(d,a);b.publicInviteUrl=h(d);b.$digest();return i("inviteUrl")})};g.$inject=["$scope","settingsDAO"];this.FriendsController=c;this.FriendEditController=a;this.FriendViewController=e;this.ShareStuffController=g}).call(this);(function(){var a,e,c,g,f,h;h=utils.log;g=utils.focus;f=function(a){return!utils.isBlank(a.title)};c={friends:"Friends","public":"Public"};a=function(a,e){a.stuffList=[];a.isAddStuffFormHidden=!0;a.circles=c;e.list(function(b){a.stuffList=b;a.isAddStuffFormHidden=0<a.stuffList.length;a.status="LOADED";return a.$digest()});a.showAddForm=function(){a.isAddStuffFormHidden=!1;return g("title")};a.stuff=new Stuff;a.addStuff=function(){return f(a.stuff)?(a.stuffList.push(new Stuff(a.stuff)),e.save(a.stuffList,
function(){}),a.stuff=new Stuff,a.isAddStuffFormHidden=!0,g("showAddStuffFormButton")):a.showValidationErrors=!0};return g("showAddStuffFormButton")};a.$inject=["$scope","stuffDAO"];e=function(a,e,b,g){var j;a.stuff=new Stuff;a.circles=c;e.getItem(b.id,function(b){a.stuff=new Stuff(b);return a.$digest()});j=function(){return a.$apply(function(){return g.path("/mystuff")})};a.save=function(){return f(a.stuff)?(h(a.stuff),a.stuff.modify(),e.saveItem(a.stuff,j)):a.showValidationErrors=!0};return a["delete"]=
function(){if(window.confirm('Do you really want to delete this stuff called "'+a.stuff.title+'"?'))return e.deleteItem(a.stuff.id,j)}};e.$inject=["$scope","stuffDAO","$routeParams","$location"];this.MyStuffController=a;this.MyStuffEditController=e}).call(this);(function(){var a,e;e=utils.log;a=function(a,g,f,h){var d,i,b;a.stuffList=[];a.filteredStuffList=[];a.sortAttribute="-modified";a.sortAttributeNames={"-modified":"Newest",title:"Title","owner.name":"Friend"};a.status="LOADING";i=void 0;d=function(){return a.filteredStuffList=utils.search(a.stuffList,a.searchQuery)};b=function(){e("list friend's stuff");return h.list(function(e,f){a.stuffList=e;"LOADED"!==a.status&&(a.status=f);d();a.$digest();if("LOADED"===f)return i=setTimeout(b,6E4)})};g(function(){h.clearCache();
return b()});a.sortBy=function(b){e(b);return a.sortAttribute=b};a.$watch("searchQuery",d);return a.$on("$destroy",function(){i&&clearTimeout(i);return e("destroyed FriendsStuffController")})};a.$inject=["$scope","$defer","friendDAO","friendsStuffDAO"];this.FriendsStuffController=a}).call(this);var log=utils.log;function AboutController(a){log("About");log(a.session);a.bla="blase";log(utils.randomString(10))}AboutController.$inject=["$scope"];angular.module("myApp.directives",[]).directive("appVersion",["version",function(a){return function(e,c){c.text(a)}}]).directive("appSelectOnFocus",[function(){return function(a,e){e.bind("focus",function(){setTimeout(function(){e.select()},100)})}}]).directive("stuffImage",[function(){return function(a,e,c){e.addClass("stuffImageBox");a.$watch(c.src,function(){var a=c.src;if(utils.isBlank(a))e.hide();else{var f=new Image;f.src=a;f.className="stuffImage";window.elm=e;e.append(f)}})}}]);angular.module("myApp.filters",[]).filter("interpolate",["version",function(a){return function(e){return(""+e).replace(/\%VERSION\%/mg,a)}}]);(function(){var a,e,c,g;g=utils.focus;a=function(a,c){a.secret="Loading secret ...";return c.getSecret(function(c){a.secret=c;return a.$digest()})};a.$inject=["$scope","settingsDAO"];e=function(a,c,d){return a["export"]=function(){return d.list(function(d){return c.list(function(b){utils.cleanObjectFromAngular(d);utils.cleanObjectFromAngular(b);a.exportedData=JSON.stringify({stuff:d,friends:b});a.$digest();return g("exportTextarea")})})}};e.$inject=["$scope","friendDAO","stuffDAO"];c=function(a,c,
d){a.importDataText="";return a.startImport=function(){var e,b,g;e=JSON.parse(a.importDataText);g=0;b=function(){g--;if(0===g)return window.alert("Import Done!"),a.importDataText=""};null!=e&&e.stuff&&(g++,d.save(e.stuff,b));if(null!=e&&e.friends)return g++,c.save(e.friends,b)}};c.$inject=["$scope","friendDAO","stuffDAO"];this.AccountController=a;this.ExportController=e;this.ImportController=c}).call(this);(function(){var a,e,c;e=utils.log;c=remoteStorageUtils;a=function(a,f){e("Login");return a.login=function(){var h;try{return h=a.userAddress,e("userAddress:"+h),h?c.connectAndAuthorize(h,["public","sharedstuff"],function(){var c;localStorage.setItem("userAddress",h);a.setLoggenOn();c=sessionStorage.getItem("targetPath")||"/";sessionStorage.removeItem("targetPath");return a.$apply(function(){return f.path(c).replace()})}):alert("Please enter a remote storage id!")}catch(d){return e(d)}}};a.$inject=
["$scope","$location","settingsDAO"];this.LoginController=a}).call(this);angular.module("myApp",["ngSanitize","myApp.filters","myApp.services","myApp.directives"]).config(["$routeProvider",function(a){a.when("/login",{template:"partials/login.html",controller:LoginController});a.when("/mystuff",{template:"partials/my-stuff.html",controller:MyStuffController});a.when("/mystuff/:id",{template:"partials/my-stuff-edit.html",controller:MyStuffEditController});a.when("/share-stuff",{template:"partials/share-stuff.html",controller:ShareStuffController});a.when("/friends",{template:"partials/friends.html",
controller:FriendsController});a.when("/friends/:id",{template:"partials/friend-edit.html",controller:FriendEditController});a.when("/addFriend/:userAddress/:secret",{template:"partials/friends.html",controller:FriendsController});a.when("/addFriend/:userAddress",{template:"partials/friends.html",controller:FriendsController});a.when("/invitation/:userAddress/:secret",{template:"partials/friend.html",controller:FriendViewController});a.when("/invitation/:userAddress",{template:"partials/friend.html",
controller:FriendViewController});a.when("/friends-stuff",{template:"partials/friends-stuff.html",controller:FriendsStuffController});a.when("/account",{template:"partials/account.html",controller:AccountController});a.when("/export",{template:"partials/account-export.html",controller:ExportController});a.when("/import",{template:"partials/account-import.html",controller:ImportController});a.when("/settings",{template:"partials/account-settings.html",controller:AccountController});a.when("/about",
{template:"partials/about.html",controller:AboutController});a.otherwise({redirectTo:"/friends-stuff"})}]);angular.element(document).ready(function(){angular.bootstrap(document,["myApp"])});
