(function(){var c,g,f,d,e=Object.prototype.hasOwnProperty;c=function(b,c){var a,d;d=[];for(a=b;b<=c?a<=c:a>=c;b<=c?a++:a--)d.push(String.fromCharCode(a));return d};f=function(){var b;b=[];for(d=0;9>=d;d++)b.push(""+d);return b}().concat(c(65,90)).concat(c(97,122));g=function(b){return b[Math.floor(Math.random()*b.length)]};this.utils={log:function(b){return console.log(b)},focus:function(b){return setTimeout(function(){return $("#"+b).focus()},100)},cleanObjectFromAngular:function(b){var c,a,d,f,
g;g=[];d=0;for(f=b.length;d<f;d++)c=b[d],g.push(function(){var b;b=[];for(a in c)e.call(c,a)&&(0<=a.indexOf("$$")?b.push(delete c[a]):b.push(void 0));return b}());return g},randomString:function(b){var c,a;a=[];for(c=0;0<=b?c<=b:c>=b;0<=b?c++:c--)a.push(g(f));return a.join("")},doNothing:function(){},defer:function(b){return setTimeout(function(){return b()},1)},isBlank:function(b){return!b||/^\s*$/.test(b)},focusAndSelect:function(b){return setTimeout(function(){return $("#"+b).focus().select},100)},
applyIfNeeded:function(b,c){return b.$root.$$phase?c():b.$apply(c)}}}).call(this);var remoteStorageUtils=function(){function c(){return location.href.substring(0,location.href.length-location.hash.length).replace(/\/[^\/]*$/,"")+"/remote-storage-login-popup.html"}function g(a,b){remoteStorage.getStorageInfo(a,function(a,c){a?(alert("Could not load storage info"),console.log(a)):(console.log("Storage info received:"),console.log(c),localStorage.setItem(h,JSON.stringify(c)));b(a,c)})}function f(a,c,d,e){var f=JSON.parse(localStorage.getItem(h)),g=localStorage.getItem(b);remoteStorage.createClient(f,
a,g).put(c,d,function(b){b?(console.log('Could not store "'+c+'" in "'+a+'" category'),console.log(b)):console.log('Stored "'+d+'" for key "'+c+'" in "'+a+'" category');e&&e(b)})}var d,e,b="remoteStorageToken",h="userStorageInfo";window.addEventListener("message",function(a){a.origin==location.protocol+"//"+location.host&&(console.log("Received an OAuth token: "+a.data),localStorage.setItem(b,a.data),d(a.data))},!1);return{connect:g,authorize:function(a,b){d=b;var e=JSON.parse(localStorage.getItem(h)),
f=c();console.log("RedirectUrl: "+f);e=remoteStorage.createOAuthAddress(e,a,f);window.open(e)},connectAndAuthorize:function(a,b,f){d=f;var h=c();e=window.open(h);g(a,function(a,c){if(c){var d=remoteStorage.createOAuthAddress(c,b,h);e.location.replace(d)}else e.close()})},getItem:function(a,c,d){var e=JSON.parse(localStorage.getItem(h));if("public"==a)e=remoteStorage.createClient(e,"public");else var f=localStorage.getItem(b),e=remoteStorage.createClient(e,a,f);e.get(c,function(b,e){b?console.log(b):
void 0==e?console.log("There wasn't anything for \""+c+'" in category "'+a+'"'):console.log('We received this for key "'+c+'" in category "'+a+'": '+e);d(b,e)})},setItem:f,isLoggedOn:function(a){(!localStorage.getItem(h)||!localStorage.getItem(b))&&setTimeout(function(){a(!1)},10);try{f("sharedstuff","loggedOnTest","test",function(b){a(!b)})}catch(c){a(!1)}},deleteToken:function(){localStorage.removeItem(b)}}}();(function(){var c,g;g=function(){function c(d){var e;this.title=(null!=d?d.title:void 0)||"";this.description=(null!=d?d.description:void 0)||"";this.visibility=(null!=d?d.visibility:void 0)||"friends";e=(new Date).getTime();this.id=(null!=d?d.id:void 0)||""+e;this.created=(null!=d?d.created:void 0)||e;this.modified=(null!=d?d.modified:void 0)||this.created}c.prototype.modify=function(){return this.modified=(new Date).getTime()};return c}();c=function(){function c(d){d=d||{};this.id=d.id||""+(new Date).getTime();
this.name=d.name||d.userAddress||"";this.userAddress=d.userAddress||"";this.secret=d.secret||""}c.prototype.sanitize=function(){if(utils.isBlank(this.name))return this.name=this.userAddress};return c}();this.Stuff=g;this.Friend=c}).call(this);(function(){var c,g,f,d,e,b,h,a,k,l,i,j=Object.prototype.hasOwnProperty,m=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);c.prototype=b.prototype;a.prototype=new c;a.__super__=b.prototype;return a};k=utils.log;a=utils.isBlank;b=utils.doNothing;l=utils.randomString;e=utils.defer;i=remoteStorageUtils;f=function(){function a(b,c){this.category=b;this.key=c}a.prototype.readAllItems=function(a){var b;b=this;return b.dataCache?e(function(){return a(b.dataCache.items)}):
i.getItem(this.category,this.key,function(c,d){b.dataCache=JSON.parse(d||'{"items":[]}');b.dataCache.items||(b.dataCache.items=[]);return a(b.dataCache.items)})};a.prototype.findItemByID=function(a,b){return _.find(a,function(a){return a.id===b})};a.prototype.list=function(a){return this.readAllItems(a)};a.prototype.getItem=function(a,b){return this.readAllItems(function(c){return b(_.find(c,function(b){return b.id===a}))})};a.prototype.save=function(a,b){utils.cleanObjectFromAngular(a);this.dataCache||
(this.dataCache={});this.dataCache.items=a;return i.setItem(this.category,this.key,JSON.stringify(this.dataCache),b)};a.prototype.saveItem=function(a,b){var c;c=this;return this.readAllItems(function(d){var e;(e=c.findItemByID(d,a.id))?d[_.indexOf(d,e)]=a:d.push(a);return c.save(d,b)})};a.prototype.deleteItem=function(a,b){var c;c=this;return this.readAllItems(function(d){var e;e=c.findItemByID(d,a);return c.save(_.without(d,e),b)})};return a}();g=function(a){function c(a,b,d){this.category=a;this.key=
b;this.settingsDAO=d}m(c,a);c.prototype.save=function(a,d){var e;c.__super__.save.call(this,a,d);this.settingsDAO.getSecret(function(c){return i.setItem("public","sharedstuff-"+c,JSON.stringify(a),b)});e=_.filter(a,function(a){return"public"===a.visibility});return i.setItem("public","sharedstuff-public",JSON.stringify(e),b)};return c}(f);(function(){function a(b){this.key=b}a.prototype.readAllItems=function(){return JSON.parse(localStorage.getItem(this.key)||"[]")};a.prototype.findItemByID=function(a,
b){return _.find(a,function(a){return a.id===b})};a.prototype.list=function(a){return a(this.readAllItems())};a.prototype.getItem=function(a,b){return b(_.find(this.readAllItems(),function(b){return b.id===a}))};a.prototype.save=function(a){utils.cleanObjectFromAngular(a);return localStorage.setItem(this.key,JSON.stringify(a))};a.prototype.saveItem=function(a){var b,c;b=this.readAllItems();c=this.findItemByID(b,a.id);b[_.indexOf(b,c)]=a;return this.save(b)};a.prototype.deleteItem=function(a){var b;
b=this.readAllItems();a=this.findItemByID(b,a);return this.save(_.without(b,a))};return a})();d=function(){function a(){this.settings=null;this.key="settings"}a.prototype.readSettings=function(a){var b;b=this;return b.settings?e(function(){return a(b.settings)}):i.getItem("sharedstuff",b.key,function(c,d){var e;e=JSON.parse(d||"{}");b.settings=e;if(e.secret)return a(e);e.secret=l(20);return i.setItem("sharedstuff",b.key,JSON.stringify(e),function(){return a(e)})})};a.prototype.getSecret=function(a){return this.readSettings(function(b){return a(b.secret)})};
return a}();c=function(){function a(b){this.friendDAO=b;this.friendsStuffList=[]}a.prototype.listStuffByFriend=function(a,b){if(a.userAddress)return remoteStorage.getStorageInfo(a.userAddress,function(c,d){var e;e=remoteStorage.createClient(d,"public");return d?e.get(h(a),function(a,c){return c?b(JSON.parse(c||"[]")):b([])}):k(c)})};a.prototype.validateFriend=function(a,b){return utils.isBlank(a.userAddress)?b(["userAddress"]):remoteStorage.getStorageInfo(a.userAddress,function(c,d){var e;if(d)return e=
remoteStorage.createClient(d,"public"),e.get(h(a),function(a,c){if(c)return b([]);k(a);return b(["secret"])});k(c);return b(["userAddress"])})};a.prototype.list=function(a){var b;b=this;return this.friendDAO.list(function(c){var d,e,f,g,h;h=[];f=0;for(g=c.length;f<g;f++)e=c[f],d=function(c){return function(d){b._updateWithLoadedItems(c,d);return a(b.friendsStuffList)}},h.push(b.listStuffByFriend(e,d(e)));return h})};a.prototype._updateWithLoadedItems=function(a,b){var c,d,e,f,g;g=[];e=0;for(f=b.length;e<
f;e++)d=b[e],d.owner=a,(c=_.find(this.friendsStuffList,function(a){return a.id===d.id}))?g.push(this.friendsStuffList[_.indexOf(this.friendsStuffList,c)]=d):g.push(this.friendsStuffList.push(d));return g};return a}();h=function(b){return"sharedstuff-"+(!a(b.secret)?b.secret:"public")};f=new f("sharedstuff","myFriendsList");d=new d;angular.module("myApp.services",[]).value("version","0.1").value("settingsDAO",d).value("stuffDAO",new g("sharedstuff","myStuffList",d)).value("friendDAO",f).value("friendsStuffDAO",
new c(f))}).call(this);(function(){var c,g,f,d;f=utils.log;g=utils.applyIfNeeded;d=function(c){return!_.any(["invitation","login"],function(b){return 1===c.indexOf(b)})};c=function(c,b){var h;c.session={userAddress:localStorage.getItem("userAddress"),isLoggedIn:!1};c.logout=function(){remoteStorageUtils.deleteToken();c.session={userAddress:null,isLoggedIn:!1};return b.path("/login")};c.setLoggenOn=function(){c.session={userAddress:localStorage.getItem("userAddress"),isLoggedIn:!0};return c.$digest()};h=function(){var a;
a=b.path();f(a);if(!c.session.isLoggedIn&&d(b.path()))return sessionStorage.setItem("targetPath",a),g(c,function(){return b.path("/login")})};return remoteStorageUtils.isLoggedOn(function(a){a?c.setLoggenOn():(c.session={userAddress:null,isLoggedIn:!1},h());return c.$on("$beforeRouteChange",h)})};c.$inject=["$scope","$location","settingsDAO"];this.AppController=c}).call(this);(function(){var c,g,f,d,e,b,h;b=utils.focus;h=utils.focusAndSelect;f=function(a,c,f,g,j){a.friendList=[];a.isAddFriendFormHidden=!0;a.isInviteFriendFormHidden=!0;a.inviteUrl="Loading...";c.list(function(b){a.friendList=b;a.isAddFriendFormHidden=0<a.friendList.length;j.userAddress&&(a.friend=new Friend({userAddress:j.userAddress,secret:j.secret}),a.isAddFriendFormHidden=!1);return a.$digest()});a.showAddForm=function(){a.isAddFriendFormHidden=!1;a.isInviteFriendFormHidden=!0;return b("name")};a.friend=
new Friend;a.addFriend=function(){a.friend.sanitize();return f.validateFriend(a.friend,function(d){if(0===d.length)return a.friendList.push(new Friend(a.friend)),c.save(a.friendList),a.friend=new Friend,a.isAddFriendFormHidden=!0,a.$digest(),b("showAddFriendFormButton");a.showValidationErrors=!0;return window.alert(d.join(",")+" seems invalid")})};a.inviteFriend=function(){a.isInviteFriendFormHidden=!1;a.isAddFriendFormHidden=!0;return g.getSecret(function(b){var c;c=a.session.userAddress;a.inviteUrl=
d(c,b);a.publicInviteUrl=e(c);a.$digest();return h("inviteUrl")})};a.closeInviteFriend=function(){return a.isInviteFriendFormHidden=!0};return b("showAddFriendFormButton")};d=function(a,b){return e(a)+"/"+b};e=function(a){var b;b=window.location;return b.protocol+"//"+b.host+b.pathname+"#"+("/invitation/"+a)};f.$inject=["$scope","friendDAO","friendsStuffDAO","settingsDAO","$routeParams"];c=function(a,b,c,d,e){var f;a.friend=new Friend;a.editMode=!1;a.stuffList=[];a.showValidationErrors=!0;b.getItem(d.id,
function(b){a.friend=new Friend(b);a.$digest();return c.listStuffByFriend(b,function(b){a.stuffList=b;return a.$digest()})});f=function(){return a.$apply(function(){return e.path("/friends")})};a.save=function(){a.friend.sanitize();return c.validateFriend(a.friend,function(c){return 0===c.length?b.saveItem(a.friend,f):window.alert(c.join(",")+" seems invalid")})};a.showEditMode=function(){return a.editMode=!0};return a["delete"]=function(){if(window.confirm('Do you really want to delete your friend "'+
a.friend.name+'"?'))return b.deleteItem(a.friend.id,f)}};c.$inject=["$scope","friendDAO","friendsStuffDAO","$routeParams","$location"];g=function(a,b,c,d,e){var f;a.stuffList=[];f=new Friend({userAddress:d.userAddress,secret:d.secret});a.friend=f;c.listStuffByFriend(f,function(b){a.stuffList=b;return a.$digest()});return a.addFriend=function(){return e.path("/addFriend/"+f.userAddress+"/"+f.secret)}};g.$inject=["$scope","friendDAO","friendsStuffDAO","$routeParams","$location"];this.FriendsController=
f;this.FriendEditController=c;this.FriendViewController=g}).call(this);(function(){var c,g,f,d,e;d=utils.focus;e=function(b){return!utils.isBlank(b.title)};f={friends:"Friends","public":"Public"};c=function(b,c){b.stuffList=[];b.isAddStuffFormHidden=!0;b.circles=f;c.list(function(a){b.stuffList=a;b.isAddStuffFormHidden=0<b.stuffList.length;return b.$digest()});b.showAddForm=function(){b.isAddStuffFormHidden=!1;return d("title")};b.stuff=new Stuff;b.addStuff=function(){return e(b.stuff)?(b.stuffList.push(new Stuff(b.stuff)),c.save(b.stuffList,function(){}),b.stuff=new Stuff,
b.isAddStuffFormHidden=!0,d("showAddStuffFormButton")):b.showValidationErrors=!0};return d("showAddStuffFormButton")};c.$inject=["$scope","stuffDAO"];g=function(b,c,a,d){var g;b.stuff=new Stuff;b.circles=f;c.getItem(a.id,function(a){b.stuff=new Stuff(a);return b.$digest()});g=function(){return b.$apply(function(){return d.path("/mystuff")})};b.save=function(){return e(b.stuff)?(b.stuff.modify(),c.saveItem(b.stuff,g)):b.showValidationErrors=!0};return b["delete"]=function(){if(window.confirm('Do you really want to delete this stuff called "'+
b.stuff.title+'"?'))return c.deleteItem(b.stuff.id,g)}};g.$inject=["$scope","stuffDAO","$routeParams","$location"];this.MyStuffController=c;this.MyStuffEditController=g}).call(this);(function(){var c,g;g=utils.log;c=function(c,d,e,b){c.stuffList=[];c.sortAttribute="-modified";c.sortAttributeNames={"-modified":"Newest",title:"Title","owner.name":"Friend"};d(function(){return b.list(function(b){c.stuffList=b;return c.$digest()})});return c.sortBy=function(b){g(b);return c.sortAttribute=b}};c.$inject=["$scope","$defer","friendDAO","friendsStuffDAO"];this.FriendsStuffController=c}).call(this);var log=utils.log;function AboutController(c){log("About");log(c.session);c.bla="blase";log(utils.randomString(10))}AboutController.$inject=["$scope"];angular.module("myApp.directives",[]).directive("appVersion",["version",function(c){return function(g,f){f.text(c)}}]).directive("appSelectOnFocus",[function(){return function(c,g){g.bind("focus",function(){g.select()})}}]);angular.module("myApp.filters",[]).filter("interpolate",["version",function(c){return function(g){return(""+g).replace(/\%VERSION\%/mg,c)}}]);(function(){var c,g,f,d;d=utils.focus;c=function(c,b){c.secret="Loading secret ...";return b.getSecret(function(b){c.secret=b;return c.$digest()})};c.$inject=["$scope","settingsDAO"];g=function(c,b,f){return c["export"]=function(){return f.list(function(a){return b.list(function(b){utils.cleanObjectFromAngular(a);utils.cleanObjectFromAngular(b);c.exportedData=JSON.stringify({stuff:a,friends:b});c.$digest();return d("exportTextarea")})})}};g.$inject=["$scope","friendDAO","stuffDAO"];f=function(c,b,
d){c.importDataText="";return c.startImport=function(){var a,f,g;a=JSON.parse(c.importDataText);g=0;f=function(){g--;if(0===g)return window.alert("Import Done!"),c.importDataText=""};null!=a&&a.stuff&&(g++,d.save(a.stuff,f));if(null!=a&&a.friends)return g++,b.save(a.friends,f)}};f.$inject=["$scope","friendDAO","stuffDAO"];this.AccountController=c;this.ExportController=g;this.ImportController=f}).call(this);(function(){var c,g,f;g=utils.log;f=remoteStorageUtils;c=function(c,e){g("Login");c.session.isLoggedIn=!1;c.userAddress="";return c.login=function(){var b;try{return b=c.userAddress,g("userAddress:"+b),b?f.connectAndAuthorize(b,["public","sharedstuff"],function(){var a;localStorage.setItem("userAddress",b);c.setLoggenOn();a=sessionStorage.getItem("targetPath")||"/";sessionStorage.removeItem("targetPath");return c.$apply(function(){return e.path(a)})}):alert("Please enter a remote storage id!")}catch(h){return g(h)}}};
c.$inject=["$scope","$location","settingsDAO"];this.LoginController=c}).call(this);angular.module("myApp",["myApp.filters","myApp.services","myApp.directives"]).config(["$routeProvider",function(c){c.when("/login",{template:"partials/login.html",controller:LoginController});c.when("/mystuff",{template:"partials/my-stuff.html",controller:MyStuffController});c.when("/mystuff/:id",{template:"partials/my-stuff-edit.html",controller:MyStuffEditController});c.when("/friends",{template:"partials/friends.html",controller:FriendsController});c.when("/friends/:id",{template:"partials/friend-edit.html",
controller:FriendEditController});c.when("/addFriend/:userAddress/:secret",{template:"partials/friends.html",controller:FriendsController});c.when("/addFriend/:userAddress",{template:"partials/friends.html",controller:FriendsController});c.when("/invitation/:userAddress/:secret",{template:"partials/friend.html",controller:FriendViewController});c.when("/invitation/:userAddress",{template:"partials/friend.html",controller:FriendViewController});c.when("/friends-stuff",{template:"partials/friends-stuff.html",
controller:FriendsStuffController});c.when("/account",{template:"partials/account.html",controller:AccountController});c.when("/export",{template:"partials/account-export.html",controller:ExportController});c.when("/import",{template:"partials/account-import.html",controller:ImportController});c.when("/settings",{template:"partials/account-settings.html",controller:AccountController});c.when("/about",{template:"partials/about.html",controller:AboutController});c.otherwise({redirectTo:"/friends-stuff"})}]);
angular.element(document).ready(function(){angular.bootstrap(document,["myApp"])});
